name: Linter - Continuous Deployment

on:
  push:
    branches:
      - main
      - linter-cd

  pull_request:
    branches:
      - main
      - linter-cd

  workflow_dispatch:

jobs:
  create-dockerimage:
      runs-on: ubuntu-22.04
      defaults:
        run:
          working-directory: linter

      steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          gcloud auth configure-docker

      - name: Write GCP Service Account Key to File
        run: echo "$GCP_SA_KEY" > ../.github/gcp-sa-key.json
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

      - name: Authenticate with Google Cloud
        run: gcloud auth activate-service-account --key-file=../.github/gcp-sa-key.json

      - name: Copy conan-profile.sh to linter directory
        run: cp ../.github/scripts/conan-profile.sh conan-profile.sh

      - name: Create Dockerimage
        run: docker build -t nutc-linter:latest .

      - name: Push Docker image
        run: |
          docker tag nutc-linter:latest gcr.io/${{ secrets.GCP_PROJECT_ID }}/nutc-linter:latest
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/nutc-linter:latest

      - name: Deploy to Cloud Run
        run: >
          gcloud run deploy nutc-linter 
          --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/nutc-linter:latest 
          --region us-central1 
          --platform managed

