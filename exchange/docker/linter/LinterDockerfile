#build stage
FROM python:3.12 as build

RUN pip install conan numpy pandas polars scipy scikit-learn sortedcontainers lightgbm\
    # c++ stuff
    && apt update \
    && apt install -y --no-install-recommends build-essential libssl-dev cmake git

WORKDIR /app/exchange
COPY ./exchange/conanfile.py /app/exchange/conanfile.py
COPY ./.github/scripts/conan-profile.sh /app/exchange

RUN cat conan-profile.sh | bash \
    && conan install . -b missing

COPY ./exchange/src /app/exchange/src
COPY ./exchange/CMakeLists.txt /app/exchange
COPY ./exchange/CMakePresets.json /app/exchange
COPY ./exchange/cmake /app/exchange/cmake
COPY ./exchange/test /app/exchange/test

ARG firebase_emulator=false

RUN if [ "$firebase_emulator" = "false" ]; then \
    cmake --preset=ci-docker; \
    else \
    cmake --preset=ci-docker -DLOCAL_DEV=ON; \
    fi

RUN cmake --build build --config Release -j

ENV NUTC_LINTER_SPAWNER_BINARY_PATH="/bin/LINTER_spawner"

RUN mv /app/exchange/build/LINTER_spawner /bin/LINTER_spawner
RUN mv /app/exchange/build/linter /bin/LINTER

RUN chmod +x /bin/LINTER
RUN chmod +x /bin/LINTER_spawner

COPY ./exchange/template.cpp /app/template.cpp
ENV NUTC_CPP_TEMPLATE_PATH="/app/template.cpp"

EXPOSE 18081

CMD LINTER
